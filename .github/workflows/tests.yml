name: Tests

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  contents: read

jobs:
  # Check code formatting
  test-format:
    name: Format
    uses: ./.github/workflows/test-format.yml

  # Run linters
  test-lint:
    name: Lint
    uses: ./.github/workflows/test-lint.yml

  # Run unit tests on macOS and Windows
  test-unit-macos:
    name: Unit Tests (macOS)
    uses: ./.github/workflows/test-unit.yml
    with:
      os: macos-latest
      upload-coverage: true

  test-unit-windows:
    name: Unit Tests (Windows)
    uses: ./.github/workflows/test-unit.yml
    with:
      os: windows-latest
      upload-coverage: true

  # Verify plugin builds on all platforms
  test-can-build:
    name: Can Build
    uses: ./.github/workflows/test-can-build.yml

  # Summary job that depends on all checks
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs:
      [
        test-format,
        test-lint,
        test-unit-macos,
        test-unit-windows,
        test-can-build,
      ]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.test-format.result }}" != "success" ] || \
             [ "${{ needs.test-lint.result }}" != "success" ] || \
             [ "${{ needs.test-unit-macos.result }}" != "success" ] || \
             [ "${{ needs.test-unit-windows.result }}" != "success" ] || \
             [ "${{ needs.test-can-build.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed successfully"
