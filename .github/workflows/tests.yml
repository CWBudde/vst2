name: Tests

on:
  push:
    branches:
      - master
  pull_request:

permissions:
  contents: read

jobs:
  # Check code formatting
  format:
    name: Format Check
    uses: ./.github/workflows/format.yml
    with:
      go-version: '1.x'

  # Run linters
  lint:
    name: Lint
    uses: ./.github/workflows/lint.yml
    with:
      go-version: '1.x'

  # Run unit tests on macOS and Windows
  test-macos:
    name: Unit Tests (macOS)
    uses: ./.github/workflows/go-test.yml
    with:
      os: macos-latest
      go-version: '1.x'
      upload-coverage: true

  test-windows:
    name: Unit Tests (Windows)
    uses: ./.github/workflows/go-test.yml
    with:
      os: windows-latest
      go-version: '1.x'
      upload-coverage: true

  # Verify plugin builds on macOS and Windows
  build-plugin-macos:
    name: Plugin Build (macOS)
    uses: ./.github/workflows/plugin-build.yml
    with:
      os: macos-latest
      go-version: '1.x'

  build-plugin-windows:
    name: Plugin Build (Windows)
    uses: ./.github/workflows/plugin-build.yml
    with:
      os: windows-latest
      go-version: '1.x'

  # Summary job that depends on all checks
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [format, lint, test-macos, test-windows, build-plugin-macos, build-plugin-windows]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.format.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test-macos.result }}" != "success" ] || \
             [ "${{ needs.test-windows.result }}" != "success" ] || \
             [ "${{ needs.build-plugin-macos.result }}" != "success" ] || \
             [ "${{ needs.build-plugin-windows.result }}" != "success" ]; then
            echo "One or more checks failed"
            exit 1
          fi
          echo "All checks passed successfully"
